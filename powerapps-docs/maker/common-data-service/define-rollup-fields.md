---
title: Определение полей свертки с помощью PowerApps | Документы Майкрософт
description: Узнайте, как определять поля свертки
ms.custom: ''
ms.date: 05/23/2018
ms.reviewer: ''
ms.service: crm-online
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
applies_to:
- Dynamics 365 (online)
- Dynamics 365 Version 9.x
- powerapps
author: Mattp123
ms.assetid: ff0504a1-01bd-4f9b-b884-7f84911d86c3
caps.latest.revision: 58
ms.author: matp
manager: kvivek
ms.openlocfilehash: c76162747ac2bda27c46895290e5943b7f46739f
ms.sourcegitcommit: aba996b1773ecdf62758e06b34eaf57bede29e08
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/08/2018
ms.locfileid: "39698707"
---
# <a name="define-rollup-fields-that-aggregate-values"></a>Определение полей свертки, которые агрегируют значения

Поля свертки предназначены для того, чтобы помочь пользователям преобразовать аналитические сведения в данные за счет мониторинга ключевых бизнес-показателей. Поле свертки содержит совокупное значение, рассчитываемое на основании записей, связанных с определенной записью. Это включает регулярные и активные сущности, такие как сообщения электронной почты и назначения.

В более сложных сценариях можно суммировать данные по иерархии записей. Администратор или специалист по настройке может определить поля свертки с помощью средств настройки в PowerApps без написания кода.  
  
<a name="BKMK_benefitsandcapabilities"></a> 
 
## <a name="rollup-fields-benefits-and-capabilities"></a>Преимущества и возможности полей свертки  

Преимущества и возможности полей свертки:  
  
- Простая визуальная правка. Поля свертки можно создавать с помощью редактора полей так же, как при создании обычного поля.  
- Широкий выбор функций статистической обработки. Можно суммировать данные с помощью следующих функций: `SUM`, `COUNT`, `MIN`, `MAX` и `AVG`.  
- Полная поддержка фильтра для статистической обработки. Можно настроить различные фильтры для исходной сущности или связанной сущности при задании нескольких условий.  
- Полная интеграция с пользовательским интерфейсом. Можно включать поля свертки в формы, представления, диаграммы и отчеты.  
- Поля свертки — это компоненты решения. Можно легко переносить поля свертки как компоненты между организациями и распространять их в решения.  
- Поля свертки и вычисляемые поля дополняют друг друга. Можно использовать поле свертки как часть вычисляемого поля, и наоборот.  
- Можно настроить поля свертки для использования настраиваемых элементов управления.  
  
 Вот некоторые примеры полей свертки:  
  
- Общий предполагаемый доход от открытых возможных сделок организации  
- Общий предполагаемый доход от открытых возможных сделок по всем организациям в иерархии  
- Общий предполагаемый доход от возможной сделки, включающей дочерние возможные сделки  
- Общая предполагаемая стоимость квалифицированных интересов, созданных кампанией  
- Количество высокоприоритетных открытых обращений по всем организациям в иерархии  
- Самое ранее время создания всех высокоприоритетных открытых обращений для организации  
  
Каждое поле свертки создает два дополнительных поля с шаблоном суффикса *&lt;fieldname&gt;*`_date` и *&lt;fieldname&gt;*`_state`. Поле `_date` содержит данные даты и времени, а поле `_state` имеет целочисленный тип данных. Поле `_state` имеет следующие значения:  
  
|Значение|Состояние|Описание|  
|-|-|-|  
|0|NotCalculated|Значение поля предстоит рассчитать.|  
|1|Вычисляемое|Значение поля рассчитано согласно данным последнего обновления в поле _date.|  
|2|OverflowError|В результате расчета значения поля возникла ошибка.|  
|3|OtherError|Сбой при расчете значения поля в связи со внутренней ошибкой. При следующем запуске задания расчета, скорее всего, эта ошибка будет исправлена.|  
|4|RetryLimitExceeded|Сбой при расчете значения поля из-за превышения максимального числа попыток выполнить повторный расчет значения в результате большого количества совпадений и конфликтов блокировки.|  
|5|HierarchicalRecursionLimitReached|Сбой при расчете значения поля по причине достижения максимальной глубины иерархии для расчета.|  
|6|LoopDetected|Сбой при расчете значения поля из-за обнаружения рекурсивного цикла в иерархии записи.|  
  
<a name="BKMK_calculations"></a>  
 
## <a name="rollup-calculations"></a>Расчеты свертки  

Свертки рассчитываются с помощью запланированных системных заданий, выполняемых асинхронно в фоновом режиме. Для просмотра заданий свертки и управления ими необходимо обладать правами администратора. 

### <a name="view-rollup-jobs"></a>Просмотр заданий свертки

Чтобы просмотреть задания свертки, перейдите в раздел:

1. При просмотре **решения Common Data Services по умолчанию** измените URL-адрес, удалив все после `dynamics.com`, и обновите страницу.
2. В области **Параметры** выберите **Системы** > **Системные задания**.<br />![Перейдите к системным заданиям](media/navigate-system-jobs.png)
1. В разделе "Выбор представления" выберите **Повторяющиеся системные задания**.
2. Чтобы быстро найти необходимое задание, можно отфильтровать задания по типу системного задания: **"Массовый расчет поля свертки"** или **"Расчет поля свертки"**.
 
### <a name="mass-calculate-rollup-field"></a>Массовый расчет поля свертки

**Массовый расчет поля свертки** — это повторяющееся задание, создаваемое для каждого поля свертки. Оно выполняется один раз после создания или обновления поля свертки. Задание пересчитывает указанное значение поля свертки во всех существующих записях, содержащих это поле. По умолчанию задание выполняется спустя 12 часов после создания или обновления поля. По завершении выполнения задания оно автоматически планируется для выполнения в отдаленном будущем, приблизительно через 10 лет. При изменении поля задание сбрасывается для повторного выполнения через 12 часов после обновления. Задержка в 12 часов необходима для гарантии того, что задание **массового расчета поля свертки** будет выполняться в нерабочее время организации. Рекомендуется, чтобы администратор настраивал время начала задания **массового расчета поля свертки** после создания или изменения поля свертки таким образом, чтобы задание выполнялось в нерабочее время. Например, рекомендуется выполнять задание в полночь, чтобы обеспечить эффективную обработку полей свертки.  

### <a name="calculate-rollup-field"></a>Расчет поля свертки 

**Расчет поля свертки** — это повторяющееся задание, которое позволяет выполнять инкрементные расчеты всех полей свертки в существующих записях определенной сущности. Для каждой сущности доступно только одно задание **расчета поля свертки**. Инкрементные расчеты — это расчеты, при которых задание **расчета поля свертки** обрабатывает записи, которые были созданы, обновлены или удалены по завершении выполнения задания **массового расчета поля свертки**. По умолчанию максимальный период повтора задания составляет один час. Задание автоматически создается при создании первого поля свертки в сущности и удаляется при удалении последнего поля свертки.  

## <a name="online-recalculation-option"></a>Параметр пересчета в интерактивном режиме
Если навести указатель мыши на поле свертки в форме, отобразится время последней свертки, и можно будет обновить значение свертки, щелкнув значок "Обновить" рядом с полем, как показано ниже:  

![Поле свертки в форме учетной записи](media/rollup-field-on-account-form.png)
  

Необходимо учитывать несколько моментов при использовании параметра пересчета в интерактивном режиме (обновление в форме вручную):  
  
- Необходимы привилегии на запись для сущности и права доступа на запись для исходной записи, в которой запрашивается обновление. Например, при расчете предполагаемого дохода от открытых возможных сделок организации необязательно иметь привилегии на запись для сущности возможной сделки, они необходимы только для сущности организации.  
- Этот параметр доступен только в интерактивном режиме. Он недоступен в автономном режиме.  
- Максимальное число записей во время обновления свертки составляет 50 000. При иерархической свертке это ограничение применяется к связанным записям в иерархии. При превышении предельного значения отобразится сообщение: *"Невозможно выполнить расчеты в интерактивном режиме, так как достигнут предел расчета в 50 000 связанных записей".* Это ограничение не применяется, если свертка пересчитывается автоматически при выполнении системных заданий.  
- Максимальное значение глубины иерархии равно 10 для исходной записи. При превышении предельного значения отобразится сообщение: *"Невозможно выполнить расчеты в интерактивном режиме, так как достигнут предел глубины иерархии 10 для исходной записи".* Это ограничение не применяется, если свертка пересчитывается автоматически при выполнении системных заданий.  

## <a name="modify-rollup-job-recurrence"></a>Изменение повторения задания свертки

Как системный администратор вы можете изменить шаблон повторения задания свертки, а также отложить, приостановить или возобновить задание свертки. Однако задание свертки невозможно отменить или удалить. 

Чтобы приостановить, отложить, возобновить или изменить шаблон повторения, перейдите в раздел "Системные задания". Дополнительные сведения [Просмотр заданий свертки](#view-rollup-jobs) 

На панели навигации нажмите **Действия** и выберите требуемое действие. 

Для задания **массового расчета поля свертки** доступны следующие варианты выбора: **Возобновить**, **Отложить** и **Приостановить**. 

Для задания **расчета поля свертки** доступны следующие варианты выбора: **Изменение интервала повторения**, **Возобновить**, **Отложить** и **Приостановить**.  
  
<a name="BKMK_businessscenarios"></a>  
 
## <a name="examples"></a>Примеры 

Рассмотрим несколько сценариев полей свертки. Мы суммируем данные для записи из связанных записей с использованием иерархии и без нее. Мы также суммируем данные для записи из связанных действий и действий, косвенно связанных с записью через сущность "Сторона действия". В каждом примере поле свертки определяется с помощью редактора полей. Чтобы открыть редактор полей, откройте обозреватель решений и разверните **Компоненты** > **Сущности**. Выберите требуемую сущность и выберите **Поля**. Нажмите кнопку **Создать**. В редакторе введите обязательные сведения для поля, включая **Тип поля** и **Тип данных**. В поле **Тип поля** выберите **Свертка**, после выбора типа данных. Типы данных включают десятичные или целые числа, валюту и дату/время. Нажмите кнопку **Изменить** рядом с полем **Тип поля**. Откроется редактор определения поля свертки. Определение поля свертки состоит из трех разделов: **Исходная сущность**, **Связанная сущность** и **Статистическая обработка**.  
  
-   В разделе **Исходная сущность** необходимо указать сущность, для которой определяется поле свертки, а также указать, выполняется ли статистическая обработка на основании иерархии. Можно добавить фильтры с несколькими условиями для определения записей в иерархии, которые будут использоваться для свертки.  
  
-   В разделе **Связанная сущность** укажите сущность, по которой будет выполняться статистическая обработка. Этот раздел необязателен при выборе свертки на основании иерархии в исходной сущности. Можно добавить фильтры с несколькими условиями для определения связанных записей, которые будут использоваться при расчете. Например, можно включить доход от открытых возможных сделок с годовым доходом более 1000 долларов США.  
  
-   В разделе **Статистическая обработка** укажите показатель для расчета. Можно выбрать доступные функции статистической обработки, такие как SUM, COUNT, MIN, MAX или AVG.  
  
### <a name="aggregate-data-for-a-record-from-related-records"></a>Суммирование данных для записи из связанных записей  

В этом примере иерархия не используется. Общий предполагаемый доход рассчитывается для организации на основании связанных открытых возможных сделок.  

![Статистическая обработка предполагаемого дохода для организации](media/rollup-field-no-hierarchy.png)
  
### <a name="aggregate-data-for-a-record-from-the-child-records-over-the-hierarchy"></a>Статистическая обработка данных для записи из дочерних записей на основании иерархии 
 
В этом примере рассчитывается общий предполагаемый доход от возможной сделки, включая дочерние возможные сделки, на основании иерархии.  
  
![Статистическая обработка предполагаемого дохода от возможной сделки](media/rollup-field-hierarchy-self.png)
  
### <a name="aggregate-data-for-a-record-from-the-related-records-over-the-hierarchy"></a>Статистическая обработка данных для записи из связанных записей на основании иерархии

В этом примере рассчитывается общий предполагаемый доход от открытых возможных сделок по всем организациям на основании иерархии.  
  
![Статистическая обработка предполагаемого дохода организации на основании иерархии](media/rollup-field-hierarchy.png)  
  
### <a name="aggregate-data-for-a-record-from-all-related-activities"></a>Суммирование данных для записи из всех связанных действий
  
В этом примере мы вычисляем общее время, затраченное на все действия, связанные с организацией, по которому выставлен счет. Сюда может входить время, затраченное на разговоры по телефону, встречи или пользовательские действия.  
  
В предыдущих версиях можно было определить поле свертки для отдельного действия, например звонка, факса или встречи. Но для достижения результата, как в примере ниже, было необходимо суммировать данные с помощью вычисляемых полей. Теперь это можно сделать за один шаг, определив одно поле свертки для сущности "Действие".  
  
![Свертка всех действий для организации](media/rollup-enhancements-activities.png)  
  
### <a name="aggregate-data-for-a-record-from-all-related-activities-and-activities-indirectly-related-via-the-activity-party-entity"></a>Суммирование данных для записи из всех связанных действий и действий, косвенно связанных с записью через сущность "Сторона действия"  

В этом примере мы вычисляем общее число сообщений электронной почты, отправленных в организацию, когда организация указана в поле "Кому" или "Копия" в сообщении. Для этого следует указать **Тип участия** в разделе **ФИЛЬТРЫ** для сущности "Сторона действия" в определении поля свертки. Если фильтрация не используется, при расчете будут использоваться все доступные типы участия для действия. 
 
Дополнительные сведения о сущности "Сторона действия" и типах участия для определенного действия см. в разделе [Сущность "Сторона действия"](/dynamics365/customer-engagement/developer/activityparty-entity).

  
![Связанные со сверткой сущности "Сторона действия" и "Действие"](media/rollup-enhancements-indirect-activities.png)  
  
### <a name="aggregate-data-for-a-record-from-related-records-using-the-avg-operator"></a>Суммирование данных для записи из связанных записей с помощью оператора AVG

В этом примере мы вычисляем средний предполагаемый доход от всех возможных сделок, связанных с организацией.  
  
![Средний предполагаемый доход в Dynamics 365](media/rollup-enhancements-average.PNG)  
  
В этом примере мы вычисляем средний предполагаемый доход от всех возможных сделок, связанных с организацией. Средний предполагаемый доход можно просмотреть на каждом уровне в иерархии.  
  
![Средний предполагаемый доход в Dynamics 365](media/cust-rollup-enhancements-avg-over-hierarchy.png)  
  
<a name="BKMK_considerations"></a> 

## <a name="rollup-field-considerations"></a>Рекомендации по полям свертки 

При работе с полями свертки следует учитывать ряд определенных условий и ограничений:  
  
- Можно указать не более 100 полей свертки для организации и не более 10 полей свертки на сущность.  
- Бизнес-процесс не может быть запущен в результате обновления поля свертки.  
- В условии ожидания бизнес-процесса не может использоваться поле свертки.  
- Свертка на основании поля свертки не поддерживается.  
- Свертка не может ссылаться на вычисляемое поле, использующее другое вычисляемое поле, даже если все поля другого вычисляемого поля находятся в текущей сущности.  
- При свертке фильтры можно применить только к исходной сущности или связанным сущностям, простым полям или несложным вычисляемым полям.  
- Свертку можно выполнять только на основании связанных сущностей с отношением 1:N. Невозможно выполнить свертку при использовании отношений N:N.  
- Невозможно выполнить свертку при использовании отношения 1: N для сущности "Действие" или сущности "Сторона действия".  
- В бизнес-правилах, бизнес-процессах или вычисляемых полях всегда используется последнее рассчитанное значение поля свертки.  
- Статистическая обработка поля свертки выполняется в контексте пользователя системы. Все пользователи могут просматривать одно и то же значение поля свертки. Можно управлять видимостью поля свертки с помощью безопасности на уровне полей (FLS), ограничив пользователей, имеющих доступ к полю свертки. Дополнительные сведения: [Безопасность на уровне полей](/dynamics365/customer-engagement/admin/field-level-security). 

### <a name="precision-rounding"></a>Точность округления
 
Если точность агрегируемого поля превышает точность поля свертки, точность агрегируемого поля округляется до точности поля свертки перед началом статистической обработки. Обратимся к примеру, который иллюстрирует это поведение. Предположим, что поле свертки для сущности организации имеет точность в два знака после запятой для расчета общего предполагаемого дохода по связанным возможным сделкам. Поле "Предполагаемый доход" для сущности возможности — агрегируемое поле с точностью 4 знака после запятой. В этом примере у организации имеется 2 связанных возможных сделки. Общая сумма предполагаемого дохода рассчитывается следующим образом:  
  
1. Предполагаемый доход по первой возможной сделке: $1000,0041  
1. Предполагаемый доход по второй возможной сделке: $2000,0044  
1. Агрегируемая сумма предполагаемого дохода: $1000,00 + $2000,00 = $3000,00

Как видно, для агрегируемого поля до выполнения статистической обработки производится округление до двух знаков после запятой.  
  
### <a name="different-behavior-from-associated-grids"></a>Различные режимы связанных таблиц
 
Некоторые формы сущности, например организация или контакт, содержат готовые связанные таблицы. Например, форма организации содержит "Контакты", "Обращения", "Возможные сделки" и другие таблицы. Некоторые записи, отображаемые в таблицах формы организации, напрямую связаны с записью организации, другие — косвенно, через связи с другими записями. С другой стороны, статистическая обработка поля свертки использует только прямые связи, явно определенные в определении поля свертки. Другие отношения не рассматриваются. Обратимся к следующему примеру, который иллюстрирует разницу в поведении.  
  
1. Организация A1 имеет основной контакт, P1. Обращение C1, связанное с организацией A1 (поле C1.Customer = A1), и обращение C2, связанное с контактом P1 (поле C2.Customer = P1).  
1. В таблице **Обращения** формы **Организация** для записи A1 отображается два обращения, C1 и C2.  
1. Поле свертки в сущности организации под названием "Общее число обращений" используется для подсчета обращений, связанных с организацией.  
1. В определении поля свертки организации указываются обращения, которые имеют с организацией отношения клиента. После статистической обработки общее число обращений равно 1 (обращение C1). Обращение C2 не включено в итоги, так как оно непосредственно связано с контактом, а не с организацией, и не может быть явно определено в определении поля свертки организации. В результате общее число обращений, возвращенных операцией свертки, не совпадает с числом **обращений**, отображаемых в таблице.  
  
### <a name="see-also"></a>См. также  

[Создание и изменение полей](create-edit-fields.md)<br />
[Определение вычисляемых полей](define-calculated-fields.md)<br />
[Поведение и формат поля "Дата и время"](behavior-format-date-time-field.md)<br />
[Определение и запрос иерархических данных](define-query-hierarchical-data.md)<br />
[Видео. Свертка и вычисляемые поля](http://www.youtube.com/watch?v=RoahCH1p3T8&list=PLC3591A8FE4ADBE07&index=8)<br />
[Видео. Использование Power BI](http://www.youtube.com/watch?v=PkQe4BFlBS8&list=PLC3591A8FE4ADBE07&index=3)
